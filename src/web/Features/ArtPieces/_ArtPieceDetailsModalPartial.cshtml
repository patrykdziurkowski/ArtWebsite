<div class="modal fade" id="artPieceDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Art piece details</h5>
                <button type="button" class="btn-close"></button>
            </div>
            <div class="modal-body d-flex flex-column flex-md-row">
                <div class="container-fluid">
                    <div class="row">
                        <div id="artDetailsImageContainer" class="col-7 text-center">
                            <img id="artDetailsImage" src="" class="img-fluid rounded mb-3" alt="Art Piece">
                            <div id="art-piece-about">
                                <img id="art-piece-details-artist-profile-picture" src=""
                                    alt="This art piece's artist's profile picture." />
                                <h3 id="art-piece-details-artist"></h3>
                                <p id="detailsDescription" class="mt-3"></p>
                                <p id="art-piece-details-like-count"></p>
                                <p id="art-piece-details-review-count"></p>
                                <partial name="../Tags/_TagsPartial" />
                            </div>
                            <button id="edit-art-piece-button" class="btn btn-secondary btn-sm ms-2">
                                <i class="bi bi-pencil-square"></i>'
                            </button>
                        </div>

                        <div class="col-5 d-flex flex-column" style="max-height: 70vh;">
                            <h6 class="fw-bold mb-2">Reviews</h6>

                            <div id="artReviewsContainer" class="flex-grow-1 overflow-auto border rounded p-2"
                                style="min-height: 0;"></div>

                            <button id="details-load-more-reviews" class="btn btn-outline-secondary mt-2">
                                Load more
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="details-back" class="btn btn-secondary">Back</button>
            </div>
        </div>
    </div>
</div>

<script>
    class ArtPieceDetails {
        onHidden = null;
        onBack = null;

        constructor(artPieceId) {
            fetch(`/api/artpieces/${artPieceId}`)
                .then(r => r.json())
                .then(data => {
                    this.imagePath = data.imagePath;
                    this.description = data.description;
                    document.getElementById('artDetailsImage').src = data.imagePath;
                    document.getElementById('detailsDescription').textContent = data.description;
                    document.getElementById('art-piece-details-artist-profile-picture').setAttribute("src", data.profilePicturePath);
                    document.getElementById('art-piece-details-artist').textContent = data.artistName;
                    document.getElementById('art-piece-details-artist').dataset.userId = data.artistUserId;
                    
                    const likeCountEl = document.getElementById('art-piece-details-like-count');
                    likeCountEl.textContent = '';
                    
                    const likeNumberSpan = document.createElement('span');
                    likeNumberSpan.id = 'art-piece-details-like-number';
                    likeNumberSpan.textContent = data.likeCount;
                    likeCountEl.appendChild(likeNumberSpan);
                    
                    likeCountEl.appendChild(document.createTextNode(data.likeCount === 1 ? ' like' : ' likes'));
                    
                    const reviewCountEl = document.getElementById('art-piece-details-review-count');
                    reviewCountEl.textContent = '';
                    
                    const reviewNumberSpan = document.createElement('span');
                    reviewNumberSpan.id = 'art-piece-details-review-number';
                    reviewNumberSpan.textContent = data.reviewCount;
                    reviewCountEl.appendChild(reviewNumberSpan);
                    
                    reviewCountEl.appendChild(document.createTextNode(data.reviewCount === 1 ? ' review' : ' reviews'));
                });

            this.reviewsOffset = 0;
            this.artPieceId = artPieceId;
            this.artPieceDetailsModal = new bootstrap.Modal(document.querySelector('#artPieceDetailsModal'));

            this.artPieceTags = new Tags(artPieceId, document.querySelector('#art-piece-about .art-piece-tags'));

            this.#loadReviews(false);

            // note: this is registered here via event listener instead of using boostrap's data tags
            // because of issues when using both data-bs-dismiss alongside new bootstrap.Modal(...)
            document.querySelector('#artPieceDetailsModal .btn-close').removeEventListener('click', () => this.hide());
            document.querySelector('#artPieceDetailsModal .btn-close').addEventListener('click', () => this.hide());

            document.querySelector('#edit-art-piece-button').addEventListener('click', async (e) => {
                await this.#showArtPieceEditForm(e);
            });

            document.getElementById('details-load-more-reviews').addEventListener('click', () => {
                this.#loadReviews();
            });

            document.getElementById('details-back').addEventListener('click', () => {
                this.hide();
                if (this.onBack !== null) this.onBack();
            });

            this.artPieceDetailsModal._element.addEventListener('hidden.bs.modal', () => {
                if (this.onHidden !== null) this.onHidden();
            });

            document.getElementById('artReviewsContainer').addEventListener('click', async (e) => {
                if (event.target.closest('.delete-review-button')) {
                    await this.#deleteReview(e);
                    return;
                }
            });

            const artistName = document.getElementById('art-piece-details-artist');
            artistName.removeEventListener('click', e => this.#openUserDetails(e, artistName, true));
            artistName.addEventListener('click', e => this.#openUserDetails(e, artistName, true));
        }

        get isShown() {
            return this.artPieceDetailsModal._element.classList.contains('show');
        }

        show() {
            this.artPieceDetailsModal.show();
        }

        hide() {
            this.artPieceDetailsModal.hide();
        }

        async #showArtPieceEditForm(e) {
            const aboutContainer = document.querySelector('#art-piece-about');
            
            const previousDescription = this.description;
            
            aboutContainer.textContent = '';
            
            const formDiv = document.createElement('div');
            
            const textarea = document.createElement('textarea');
            textarea.id = 'edit-art-piece-description';
            textarea.name = 'description';
            textarea.value = this.description;
            formDiv.appendChild(textarea);
            
            const buttonDiv = document.createElement('div');
            
            const saveButton = document.createElement('button');
            saveButton.id = 'edit-art-piece-save';
            saveButton.type = 'submit';
            saveButton.className = 'btn btn-primary';
            saveButton.textContent = 'Save';
            buttonDiv.appendChild(saveButton);
            
            const cancelButton = document.createElement('button');
            cancelButton.id = 'edit-art-piece-cancel';
            cancelButton.type = 'button';
            cancelButton.className = 'btn btn-secondary';
            cancelButton.textContent = 'Cancel';
            buttonDiv.appendChild(cancelButton);
            
            formDiv.appendChild(buttonDiv);
            aboutContainer.appendChild(formDiv);
            
            cancelButton.addEventListener('click', () => {
                aboutContainer.textContent = '';
                const p = document.createElement('p');
                p.id = 'detailsDescription';
                p.className = 'mt-3';
                p.textContent = this.description;
                aboutContainer.appendChild(p);
            });
            
            saveButton.addEventListener('click', async () => {
                const newDescription = document.querySelector('#edit-art-piece-description').value;
                const response = await fetch(`/api/artpieces/${this.artPieceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: newDescription
                    })
                });
                if (response.status !== 200) {
                    console.error('Unable to edit art piece: ', response, await response.json());
                    return;
                }
                
                aboutContainer.textContent = '';
                const p = document.createElement('p');
                p.id = 'detailsDescription';
                p.className = 'mt-3';
                p.textContent = newDescription;
                aboutContainer.appendChild(p);
                
                this.description = newDescription;
            });
        }

        async #deleteReview(event) {
            const reviewId = event.target.closest('.delete-review-button').dataset.reviewId;

            if (confirm('Are you sure you want to delete this review?')) {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    event.target.closest('div.d-flex.mb-3').remove();
                    document.querySelector(`.art-piece-card[data-art-piece-id="${this.artPieceId}"]`).remove();
                    this.hide();
                } else {
                    alert('Failed to delete the review.');
                }
            }
        }

        async #editReview(e, review) {
            this.#hideAllReviewEdits();
            const reviewContent = e.target.closest('.details-review').querySelector('.review-content');
            e.target.closest('.details-review').classList.add('editable-review');
            reviewContent.textContent = '';

            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';

            const textarea = document.createElement('textarea');
            textarea.className = 'form-control';
            textarea.id = 'editComment';
            textarea.value = review.comment;
            formGroup.appendChild(textarea);

            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'rating';

            for (let i = 5; i >= 1; i--) {
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `star${i}`;
                input.name = 'Rating';
                input.value = i;
                if (review.rating.value === i) {
                    input.checked = true;
                }
                ratingDiv.appendChild(input);

                const label = document.createElement('label');
                label.htmlFor = `star${i}`;
                label.innerHTML = '&#9733;';
                ratingDiv.appendChild(label);
            }

            formGroup.appendChild(ratingDiv);

            const errorSpan = document.createElement('span');
            errorSpan.className = 'text-danger';
            errorSpan.id = 'ratingError';
            formGroup.appendChild(errorSpan);

            const saveButton = document.createElement('button');
            saveButton.className = 'btn btn-primary btn-sm mt-2';
            saveButton.id = 'submitEdit';
            saveButton.textContent = 'Save';
            formGroup.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-secondary btn-sm mt-2';
            cancelButton.id = 'cancelEdit';
            cancelButton.textContent = 'Cancel';
            formGroup.appendChild(cancelButton);

            reviewContent.appendChild(formGroup);

            document.querySelector('#submitEdit').addEventListener('click', async (e) => {
                this.#sendEditRequest(e);
            });
            document.querySelector('#cancelEdit').addEventListener('click', async (e) => {
                this.#hideAllReviewEdits();
            });
        }

        #hideAllReviewEdits() {
            const previouslyEditedReviews = document.querySelectorAll('.editable-review');
            for (const reviewElement of previouslyEditedReviews) {
                const rating = reviewElement.dataset.rating;
                const comment = reviewElement.dataset.comment;

                const reviewContent = reviewElement.querySelector('.review-content');
                reviewContent.textContent = '';

                const ratingSpan = document.createElement('span');
                ratingSpan.className = 'review-rating';
                ratingSpan.textContent = rating;
                reviewContent.appendChild(ratingSpan);

                reviewContent.appendChild(document.createTextNode('★ '));

                const commentSpan = document.createElement('span');
                commentSpan.className = 'review-comment';
                commentSpan.textContent = comment;
                reviewContent.appendChild(commentSpan);
            }
        }

        async #sendEditRequest(e) {
            const reviewElement = e.target.closest('.details-review');
            const reviewId = reviewElement.dataset.reviewId;

            const formData = {
                rating: document.querySelector('input[name="Rating"]:checked').value,
                comment: document.querySelector('#editComment').value,
            };

            const response = await fetch(`/api/reviews/${reviewId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });

            if (!response.ok) {
                document.querySelector('#ratingError').innerText = "Could not edit this review.";
                return;
            }

            document.querySelector('#ratingError').innerText = "";
            this.#hideAllReviewEdits();
            reviewElement.querySelector('.review-rating').innerText = formData.rating;
            reviewElement.querySelector('.review-comment').innerText = formData.comment;
        }

        async #loadReviews(append = true) {
            const response = await fetch(`/api/artPieces/${this.artPieceId}/reviews?offset=${this.reviewsOffset}`);
            if (!response.ok) return;

            const reviews = await response.json();
            const container = document.getElementById('artReviewsContainer');

            if (!append) container.innerHTML = '';

            reviews.forEach(r => {
                const reviewEl = document.createElement('div');
                reviewEl.className = 'details-review d-flex mb-3';

                const outerDiv = document.createElement('div');

                const img = document.createElement('img');
                img.style.width = '100px';
                img.style.height = '100px';
                img.src = r.profilePicturePath;
                img.alt = "This reviewer's profile picture.";
                outerDiv.appendChild(img);

                const infoDiv = document.createElement('div');

                const reviewerNameStrong = document.createElement('strong');
                reviewerNameStrong.className = 'review-reviewer-name';
                reviewerNameStrong.dataset.userId = r.userId;
                reviewerNameStrong.textContent = r.reviewerName;
                infoDiv.appendChild(reviewerNameStrong);

                if (r.isCurrentUser) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-secondary';
                    badge.textContent = 'YOU';
                    infoDiv.appendChild(document.createTextNode(' '));
                    infoDiv.appendChild(badge);
                }

                infoDiv.appendChild(document.createTextNode(' - '));
                const pointsSpan = document.createElement('span');
                pointsSpan.className = 'review-points';
                pointsSpan.textContent = `${r.points} points`;
                infoDiv.appendChild(pointsSpan);

                infoDiv.appendChild(document.createTextNode(' - '));
                const dateSmall = document.createElement('small');
                dateSmall.textContent = new Date(r.date).toLocaleDateString();
                infoDiv.appendChild(dateSmall);

                outerDiv.appendChild(infoDiv);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'review-content';

                const ratingSpan = document.createElement('span');
                ratingSpan.className = 'review-rating';
                ratingSpan.textContent = r.rating.value;
                contentDiv.appendChild(ratingSpan);

                contentDiv.appendChild(document.createTextNode('★ '));

                const commentSpan = document.createElement('span');
                commentSpan.className = 'review-comment';
                commentSpan.textContent = r.comment;
                contentDiv.appendChild(commentSpan);

                outerDiv.appendChild(contentDiv);
                reviewEl.appendChild(outerDiv);

                if (r.isCurrentUser || r.isAdmin) {
                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<i class="bi bi-pencil-square"></i>';
                    editButton.className = 'btn edit-review-button btn-secondary btn-sm ms-2';
                    editButton.dataset.reviewId = r.reviewId;
                    editButton.addEventListener('click', async (e) => {
                        await this.#editReview(e, r);
                    });

                    reviewEl.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteButton.className = 'btn delete-review-button btn-danger btn-sm ms-2';
                    deleteButton.dataset.reviewId = r.reviewId;
                    reviewEl.appendChild(deleteButton);
                }

                if (r.isCurrentUser) reviewEl.classList.add('py-4');
                reviewEl.dataset.rating = r.rating.value;
                reviewEl.dataset.comment = r.comment;
                reviewEl.dataset.reviewId = r.reviewId;
                container.appendChild(reviewEl);
            });

            if (reviews.length > 0) this.reviewsOffset += reviews.length;

            document.querySelectorAll('.review-reviewer-name').forEach(el => {
                el.removeEventListener('click', e => this.#openUserDetails(e, el, false));
            });
            document.querySelectorAll('.review-reviewer-name').forEach(el => {
                el.addEventListener('click', e => this.#openUserDetails(e, el, false));
            });
        }

        #openUserDetails(e, el, isArtist) {
            userDetails.show(
                el,
                el.dataset.userId,
                el.textContent,
                isArtist);
        }
    }
</script>