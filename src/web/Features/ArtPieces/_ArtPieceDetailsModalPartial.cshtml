<div class="modal fade" id="artPieceDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-2">
                <h5 class="modal-title fw-bold">Art Details</h5>
                <button type="button" class="btn-close"></button>
            </div>
            <div class="modal-body d-flex flex-column flex-md-row">
                <div class="container-fluid">
                    <div class="row">
                        <div id="artDetailsImageContainer" class="col-lg-7 mb-4 mb-lg-0">
                            <img id="artDetailsImage" src="" class="img-fluid rounded shadow-sm mb-4" alt="Art Piece" style="max-height: 400px; object-fit: contain; width: 100%;">
                            
                            <div id="art-piece-about" class="card border-0 p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <img id="art-piece-details-artist-profile-picture" 
                                        src="" 
                                        alt="Artist profile picture" 
                                        class="rounded-circle me-3"
                                        style="width: 60px; height: 60px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h5 id="art-piece-details-artist" class="mb-0 text-primary cursor-pointer"></h5>
                                        <small class="text-muted">Artist</small>
                                    </div>
                                    <button id="edit-art-piece-button" class="btn btn-link text-secondary p-0 d-none">
                                        <i class="bi bi-pencil-square fs-5"></i>
                                    </button>
                                    <button id="delete-art-piece-button" class="btn btn-link text-danger p-0 ms-2 d-none">
                                        <i class="bi bi-trash fs-5"></i>
                                    </button>
                                </div>
                                
                                <p id="detailsDescription" class="mb-3"></p>
                                
                                <div class="d-flex gap-3">
                                    <span id="art-piece-details-like-count" class="badge bg-danger">
                                        <i class="bi bi-heart-fill"></i> <span id="art-piece-details-like-number"></span>
                                    </span>
                                    <span id="art-piece-details-review-count" class="badge bg-primary">
                                        <i class="bi bi-star-fill"></i> <span id="art-piece-details-review-number"></span>
                                    </span>
                                </div>
                                
                                <partial name="../Tags/_TagsPartial" />
                            </div>
                        </div>

                        <div class="col-lg-5 d-flex flex-column">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5 class="fw-bold mb-0">
                                    <i class="bi bi-chat-left-text text-primary"></i> Reviews
                                </h5>
                            </div>

                            <div id="artReviewsContainer" 
                                class="flex-grow-1 overflow-auto p-3 rounded" 
                                style="min-height: 400px; max-height: 60vh;">
                            </div>

                            <button id="details-load-more-reviews" class="btn btn-outline-primary mt-3">
                                Load More Reviews
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button id="details-back" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .cursor-pointer {
        cursor: pointer;
    }

    .cursor-pointer:hover {
        text-decoration: underline;
    }
</style>

<script>
    class ArtPieceDetails {
        onHidden = null;
        onBack = null;

        constructor(artPieceId) {
            const imageViewer = ImageViewer.getInstance();
            const img = document.getElementById('artDetailsImage');
            img.addEventListener('click', () => {
                imageViewer.open(img.src, img.alt);
            });

            fetch(`/api/artpieces/${artPieceId}`)
                .then(r => r.json())
                .then(data => {
                    this.imagePath = data.imagePath;
                    this.description = data.description;
                    document.getElementById('artDetailsImage').src = data.imagePath;
                    document.getElementById('detailsDescription').textContent = data.description;
                    document.getElementById('art-piece-details-artist-profile-picture').setAttribute("src", data.profilePicturePath);
                    document.getElementById('art-piece-details-artist').textContent = data.artistName;
                    document.getElementById('art-piece-details-artist').dataset.userId = data.artistUserId;

                    const editButton = document.querySelector('#edit-art-piece-button');
                    const deleteButton = document.querySelector('#delete-art-piece-button');
                    if (data.currentUserIsOwner || data.currentUserIsAdmin) {
                        editButton.classList.remove('d-none');
                        deleteButton.classList.remove('d-none');
                    } else {
                        editButton.classList.add('d-none');
                        deleteButton.classList.add('d-none');
                    }
                    
                    const likeCountEl = document.getElementById('art-piece-details-like-count');
                    likeCountEl.innerHTML = `<i class="bi bi-heart-fill"></i> <span id="art-piece-details-like-number">${data.likeCount}</span>`;

                    const reviewCountEl = document.getElementById('art-piece-details-review-count');
                    reviewCountEl.innerHTML = `<i class="bi bi-star-fill"></i> <span id="art-piece-details-review-number">${data.reviewCount}</span>`;
                });

            this.reviewsOffset = 0;
            this.artPieceId = artPieceId;
            this.artPieceDetailsModal = new bootstrap.Modal(document.querySelector('#artPieceDetailsModal'));

            this.artPieceTags = new Tags(artPieceId, document.querySelector('#art-piece-about .art-piece-tags'));
            this.artPieceTags.initialize();

            this.#loadReviews(false);

            // note: this is registered here via event listener instead of using boostrap's data tags
            // because of issues when using both data-bs-dismiss alongside new bootstrap.Modal(...)
            document.querySelector('#artPieceDetailsModal .btn-close').removeEventListener('click', () => this.hide());
            document.querySelector('#artPieceDetailsModal .btn-close').addEventListener('click', () => this.hide());

            document.querySelector('#edit-art-piece-button').addEventListener('click', async (e) => {
                await this.#showArtPieceEditForm(e);
            });

            document.querySelector('#delete-art-piece-button').addEventListener('click', async () => {
                await this.#deleteArtPiece();
            });

            document.getElementById('details-load-more-reviews').addEventListener('click', () => {
                this.#loadReviews();
            });

            document.getElementById('details-back').addEventListener('click', () => {
                this.hide();
                if (this.onBack !== null) this.onBack();
            });

            this.artPieceDetailsModal._element.addEventListener('hidden.bs.modal', () => {
                if (this.onHidden !== null) this.onHidden();
            });

            document.getElementById('artReviewsContainer').addEventListener('click', async (e) => {
                if (event.target.closest('.delete-review-button')) {
                    await this.#deleteReview(e);
                    return;
                }
            });

            const artistName = document.getElementById('art-piece-details-artist');
            artistName.removeEventListener('click', e => this.#openUserDetails(e, artistName, true));
            artistName.addEventListener('click', e => this.#openUserDetails(e, artistName, true));
        }

        get isShown() {
            return this.artPieceDetailsModal._element.classList.contains('show');
        }

        show() {
            this.artPieceDetailsModal.show();
        }

        hide() {
            this.#hideAllReviewEdits();
            this.#hideArtPieceEditForm();
            this.artPieceDetailsModal.hide();
        }

        #hideArtPieceEditForm() {
            const formDiv = document.querySelector('#artPieceEditForm');
            if (!formDiv) return;

            const p = document.createElement('p');
            p.id = 'detailsDescription';
            p.className = 'mb-3';
            p.textContent = this.description;
            formDiv.replaceWith(p);
        }

        async #showArtPieceEditForm(e) {
            const descriptionP = document.getElementById('detailsDescription');
            if (!descriptionP) return;

            const previousDescription = this.description;
            
            const formDiv = document.createElement('div');
            formDiv.id = "artPieceEditForm";
            formDiv.className = 'mb-3';
            
            const textarea = document.createElement('textarea');
            textarea.id = 'edit-art-piece-description';
            textarea.className = 'form-control mb-2';
            textarea.name = 'description';
            textarea.rows = 4;
            textarea.value = this.description;
            formDiv.appendChild(textarea);
            
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'd-flex gap-2';
            
            const saveButton = document.createElement('button');
            saveButton.id = 'edit-art-piece-save';
            saveButton.type = 'submit';
            saveButton.className = 'btn btn-primary btn-sm';
            saveButton.textContent = 'Save';
            buttonDiv.appendChild(saveButton);
            
            const cancelButton = document.createElement('button');
            cancelButton.id = 'edit-art-piece-cancel';
            cancelButton.type = 'button';
            cancelButton.className = 'btn btn-secondary btn-sm';
            cancelButton.textContent = 'Cancel';
            buttonDiv.appendChild(cancelButton);
            
            formDiv.appendChild(buttonDiv);
            descriptionP.replaceWith(formDiv);
            
            cancelButton.addEventListener('click', () => {
                this.#hideArtPieceEditForm();
            });
            
            saveButton.addEventListener('click', async () => {
                const newDescription = document.querySelector('#edit-art-piece-description').value;
                const response = await fetch(`/api/artpieces/${this.artPieceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: newDescription
                    })
                });
                if (response.status !== 200) {
                    console.error('Unable to edit art piece: ', response, await response.json());
                    return;
                }
                
                const p = document.createElement('p');
                p.id = 'detailsDescription';
                p.className = 'mb-3';
                p.textContent = newDescription;
                formDiv.replaceWith(p);
                
                this.description = newDescription;
            });
        }

        async #deleteReview(event) {
            const reviewId = event.target.closest('.delete-review-button').dataset.reviewId;

            if (confirm('Are you sure you want to delete this review?')) {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    event.target.closest('div.d-flex.mb-3').remove();
                    document.querySelector(`.art-piece-card[data-art-piece-id="${this.artPieceId}"]`).remove();
                    this.hide();
                } else {
                    alert('Failed to delete the review.');
                }
            }
        }

        async #editReview(e, review) {
            this.#hideAllReviewEdits();
            const reviewContent = e.target.closest('.details-review').querySelector('.review-content');
            e.target.closest('.details-review').classList.add('editable-review');
            reviewContent.textContent = '';

            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';

            const textarea = document.createElement('textarea');
            textarea.className = 'form-control';
            textarea.id = 'editComment';
            textarea.value = review.comment;
            formGroup.appendChild(textarea);

            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'rating';

            for (let i = 5; i >= 1; i--) {
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `star${i}`;
                input.name = 'Rating';
                input.value = i;
                if (review.rating.value === i) {
                    input.checked = true;
                }
                ratingDiv.appendChild(input);

                const label = document.createElement('label');
                label.htmlFor = `star${i}`;
                label.innerHTML = '&#9733;';
                ratingDiv.appendChild(label);
            }

            formGroup.appendChild(ratingDiv);

            const errorSpan = document.createElement('span');
            errorSpan.className = 'text-danger';
            errorSpan.id = 'ratingError';
            formGroup.appendChild(errorSpan);

            const saveButton = document.createElement('button');
            saveButton.className = 'btn btn-primary btn-sm mt-2';
            saveButton.id = 'submitEdit';
            saveButton.textContent = 'Save';
            formGroup.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-secondary btn-sm mt-2';
            cancelButton.id = 'cancelEdit';
            cancelButton.textContent = 'Cancel';
            formGroup.appendChild(cancelButton);

            reviewContent.appendChild(formGroup);

            document.querySelector('#submitEdit').addEventListener('click', async (e) => {
                this.#sendEditRequest(e);
            });
            document.querySelector('#cancelEdit').addEventListener('click', async (e) => {
                this.#hideAllReviewEdits();
            });
        }

        #hideAllReviewEdits() {
            const previouslyEditedReviews = document.querySelectorAll('.editable-review');
            for (const reviewElement of previouslyEditedReviews) {
                const rating = reviewElement.dataset.rating;
                const comment = reviewElement.dataset.comment;

                const reviewContent = reviewElement.querySelector('.review-content');
                reviewContent.textContent = '';

                const ratingSpan = document.createElement('span');
                ratingSpan.className = 'review-rating';
                ratingSpan.textContent = rating;
                reviewContent.appendChild(ratingSpan);

                reviewContent.appendChild(document.createTextNode('★ '));

                const commentSpan = document.createElement('span');
                commentSpan.className = 'review-comment';
                commentSpan.textContent = comment;
                reviewContent.appendChild(commentSpan);
            }
        }

        async #sendEditRequest(e) {
            const reviewElement = e.target.closest('.details-review');
            const reviewId = reviewElement.dataset.reviewId;

            const formData = {
                rating: document.querySelector('input[name="Rating"]:checked').value,
                comment: document.querySelector('#editComment').value,
            };

            const response = await fetch(`/api/reviews/${reviewId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });

            if (!response.ok) {
                document.querySelector('#ratingError').innerText = "Could not edit this review.";
                return;
            }

            document.querySelector('#ratingError').innerText = "";
            this.#hideAllReviewEdits();
            reviewElement.querySelector('.review-rating').innerText = formData.rating;
            reviewElement.querySelector('.review-comment').innerText = formData.comment;
        }

        async #deleteArtPiece() {
            if (!confirm('Are you sure you want to delete this art piece? This action cannot be undone.')) {
                return;
            }

            const response = await fetch(`/api/artpieces/${this.artPieceId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                this.hide();
                const artPieceCard = document.querySelector(`.art-piece-card[data-art-piece-id="${this.artPieceId}"]`);
                if (artPieceCard) {
                    artPieceCard.remove();
                }
            } else {
                alert('Failed to delete the art piece.');
            }
        }

        async #loadReviews(append = true) {
            const response = await fetch(`/api/artPieces/${this.artPieceId}/reviews?offset=${this.reviewsOffset}`);
            if (!response.ok) return;

            const reviews = await response.json();
            const container = document.getElementById('artReviewsContainer');

            if (!append) container.innerHTML = '';

            reviews.forEach(r => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'card border-0 shadow-sm mb-3 details-review';
                reviewCard.dataset.rating = r.rating.value;
                reviewCard.dataset.comment = r.comment;
                reviewCard.dataset.reviewId = r.reviewId;

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'd-flex align-items-center mb-3';

                const img = document.createElement('img');
                img.className = 'rounded-circle me-3';
                img.style.cssText = 'width: 50px; height: 50px; object-fit: cover;';
                img.src = r.profilePicturePath;
                img.alt = "Reviewer's profile picture";
                headerDiv.appendChild(img);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex-grow-1';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'd-flex align-items-center gap-2 mb-1';

                const reviewerNameStrong = document.createElement('strong');
                reviewerNameStrong.className = 'review-reviewer-name text-primary cursor-pointer';
                reviewerNameStrong.dataset.userId = r.userId;
                reviewerNameStrong.textContent = r.reviewerName;
                nameDiv.appendChild(reviewerNameStrong);

                if (r.isCurrentUser) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-secondary';
                    badge.textContent = 'YOU';
                    nameDiv.appendChild(badge);
                }

                infoDiv.appendChild(nameDiv);

                const metaDiv = document.createElement('div');
                metaDiv.className = 'text-muted small';
                metaDiv.innerHTML = `<i class="bi bi-trophy-fill text-warning"></i><span class="review-points">${r.points}</span> points • ${new Date(r.date).toLocaleDateString()}`;
                infoDiv.appendChild(metaDiv);

                headerDiv.appendChild(infoDiv);

                if (r.isCurrentUser || r.isAdmin) {
                    const buttonGroup = document.createElement('div');
                    buttonGroup.className = 'btn-group';

                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<i class="bi bi-pencil-square"></i>';
                    editButton.className = 'btn edit-review-button btn-sm btn-outline-secondary';
                    editButton.dataset.reviewId = r.reviewId;
                    editButton.addEventListener('click', async (e) => {
                        await this.#editReview(e, r);
                    });
                    buttonGroup.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteButton.className = 'btn delete-review-button btn-sm btn-outline-danger';
                    deleteButton.dataset.reviewId = r.reviewId;
                    buttonGroup.appendChild(deleteButton);

                    headerDiv.appendChild(buttonGroup);
                }

                cardBody.appendChild(headerDiv);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'review-content';

                const ratingDiv = document.createElement('div');
                ratingDiv.className = 'mb-2';
                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('span');
                    star.className = i < r.rating.value ? 'text-warning' : 'text-muted';
                    star.innerHTML = '★';
                    ratingDiv.appendChild(star);
                }
                contentDiv.appendChild(ratingDiv);

                const commentP = document.createElement('p');
                commentP.className = 'review-comment mb-0';
                commentP.textContent = r.comment;
                contentDiv.appendChild(commentP);

                cardBody.appendChild(contentDiv);
                reviewCard.appendChild(cardBody);
                container.appendChild(reviewCard);
            });

            if (reviews.length > 0) this.reviewsOffset += reviews.length;

            const loadMoreButton = document.getElementById('details-load-more-reviews');
            if (reviews.length < 10) {
                loadMoreButton.style.display = 'none';
            } else {
                loadMoreButton.style.display = 'block';
            }

            document.querySelectorAll('.review-reviewer-name').forEach(el => {
                el.removeEventListener('click', e => this.#openUserDetails(e, el, false));
                el.addEventListener('click', e => this.#openUserDetails(e, el, false));
            });
        }

        #openUserDetails(e, el, isArtist) {
            userDetails.show(
                el,
                el.dataset.userId,
                el.textContent,
                isArtist);
        }
    }
</script>