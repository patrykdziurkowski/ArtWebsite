<div class="modal fade" id="artPieceDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Art piece details</h5>
                <button type="button" class="btn-close"></button>
            </div>
            <div class="modal-body d-flex flex-column flex-md-row">
                <div class="container-fluid">
                    <div class="row">
                        <div id="artDetailsImageContainer" class="col-7 text-center">
                            <img id="artDetailsImage" src="" class="img-fluid rounded mb-3" alt="Art Piece">
                            <div id="art-piece-about">
                                <h3 id="art-piece-details-artist"></h3>
                                <p id="detailsDescription" class="mt-3"></p>
                            </div>
                            <button id="edit-art-piece-button" class="btn btn-secondary btn-sm ms-2">
                                <i class="bi bi-pencil-square"></i>'
                            </button>
                        </div>

                        <div class="col-5 d-flex flex-column" style="max-height: 70vh;">
                            <h6 class="fw-bold mb-2">Reviews</h6>

                            <div id="artReviewsContainer" class="flex-grow-1 overflow-auto border rounded p-2"
                                style="min-height: 0;"></div>

                            <button id="details-load-more-reviews" class="btn btn-outline-secondary mt-2">
                                Load more
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="details-back" class="btn btn-light">Back</button>
            </div>
        </div>
    </div>
</div>

<script>
    class ArtPieceDetails {
        onHidden = null;
        onBack = null;

        constructor(artPieceId) {
            fetch(`/api/artpieces/${artPieceId}`)
                .then(r => r.json())
                .then(data => {
                    this.imagePath = data.imagePath;
                    this.description = data.description;
                    document.getElementById('artDetailsImage').src = data.imagePath;
                    document.getElementById('detailsDescription').innerText = data.description;
                    document.getElementById('art-piece-details-artist').innerText = data.artistName;
                    document.getElementById('art-piece-details-artist').dataset.userId = data.artistUserId;
                });

            this.reviewsOffset = 0;
            this.artPieceId = artPieceId;
            this.artPieceDetailsModal = new bootstrap.Modal(document.querySelector('#artPieceDetailsModal'));

            this.#loadReviews(false);

            // note: this is registered here via event listener instead of using boostrap's data tags
            // because of issues when using both data-bs-dismiss alongside new bootstrap.Modal(...)
            document.querySelector('#artPieceDetailsModal .btn-close').removeEventListener('click', () => this.hide());
            document.querySelector('#artPieceDetailsModal .btn-close').addEventListener('click', () => this.hide());

            document.querySelector('#edit-art-piece-button').addEventListener('click', async (e) => {
                await this.#showArtPieceEditForm(e);
            });

            document.getElementById('details-load-more-reviews').addEventListener('click', () => {
                this.#loadReviews();
            });

            document.getElementById('details-back').addEventListener('click', () => {
                this.hide();
                if (this.onBack !== null) this.onBack();
            });

            this.artPieceDetailsModal._element.addEventListener('hidden.bs.modal', () => {
                if (this.onHidden !== null) this.onHidden();
            });

            document.getElementById('artReviewsContainer').addEventListener('click', async (e) => {
                if (event.target.closest('.delete-review-button')) {
                    await this.#deleteReview(e);
                    return;
                }
            });

            const artistName = document.getElementById('art-piece-details-artist');
            artistName.removeEventListener('click', e => this.#openUserDetails(e, artistName, true));
            artistName.addEventListener('click', e => this.#openUserDetails(e, artistName, true));
        }

        get isShown() {
            return this.artPieceDetailsModal._element.classList.contains('show');
        }

        show() {
            this.artPieceDetailsModal.show();
        }

        hide() {
            this.artPieceDetailsModal.hide();
        }

        async #showArtPieceEditForm(e) {
            const aboutContainer = document.querySelector('#art-piece-about');
            const formHtml =
                `<div>
                    <textarea id="edit-art-piece-description" name="description">${this.description}</textarea>
                    <div>
                        <button id="edit-art-piece-save" type="submit" class="btn btn-primary">Save</button>
                        <button id="edit-art-piece-cancel" type="button" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>`
            aboutContainer.innerHTML = formHtml;
            aboutContainer.querySelector('#edit-art-piece-cancel').addEventListener('click', () => {
                aboutContainer.innerHTML = `<p id="detailsDescription" class="mt-3">${this.description}</p>`;
            });
            aboutContainer.querySelector('#edit-art-piece-save').addEventListener('click', async () => {
                const newDescription = document.querySelector('#edit-art-piece-description').value;
                const response = await fetch(`/api/artpieces/${this.artPieceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: newDescription
                    })
                });

                if (response.status !== 200) {
                    console.error('Unable to edit art piece: ', response, await response.json());
                    return;
                }

                aboutContainer.innerHTML = `<p id="detailsDescription" class="mt-3">${newDescription}</p>`;
                this.description = newDescription;
            });

        }

        async #deleteReview(event) {
            const reviewId = event.target.closest('.delete-review-button').dataset.reviewId;

            if (confirm('Are you sure you want to delete this review?')) {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    event.target.closest('div.d-flex.mb-3').remove();
                    document.querySelector(`.art-piece-card[data-art-piece-id="${this.artPieceId}"]`).remove();
                    this.hide();
                } else {
                    alert('Failed to delete the review.');
                }
            }
        }

        async #editReview(e, review) {
            const reviewEditFormHtml =
                `<div class="form-group">
                    <textarea class="form-control" id="editComment">${review.comment}</textarea>
                    <div class="rating">
                        <input type="radio" id="star5" name="Rating" value="5" ${review.rating.value === 5 ? 'checked' : ''}>
                        <label for="star5">&#9733;</label>
                        <input type="radio" id="star4" name="Rating" value="4" ${review.rating.value === 4 ? 'checked' : ''}>
                        <label for="star4">&#9733;</label>
                        <input type="radio" id="star3" name="Rating" value="3" ${review.rating.value === 3 ? 'checked' : ''}>
                        <label for="star3">&#9733;</label>
                        <input type="radio" id="star2" name="Rating" value="2" ${review.rating.value === 2 ? 'checked' : ''}>
                        <label for="star2">&#9733;</label>
                        <input type="radio" id="star1" name="Rating" value="1" ${review.rating.value === 1 ? 'checked' : ''}>
                        <label for="star1">&#9733;</label>
                    </div>
                    <span class="text-danger" id="ratingError"></span>
                    <button class="btn btn-primary btn-sm mt-2" id="submitEdit">Save</button>
                    <button class="btn btn-secondary btn-sm mt-2" id="cancelEdit">Cancel</button>
                </div>`;

            this.#hideAllReviewEdits();

            const reviewContent = e.target.closest('.details-review').querySelector('.review-content');
            const reviewEl = e.target.closest('.details-review').classList.add('editable-review');
            reviewContent.innerHTML = reviewEditFormHtml;

            document.querySelector('#submitEdit').addEventListener('click', async (e) => {
                this.#sendEditRequest(e);
            });
            document.querySelector('#cancelEdit').addEventListener('click', async (e) => {
                this.#hideAllReviewEdits();
            });
        }

        #hideAllReviewEdits() {
            const previouslyEditedReviews = document.querySelectorAll('.editable-review');
            for (const reviewElement of previouslyEditedReviews) {
                const rating = reviewElement.dataset.rating;
                const comment = reviewElement.dataset.comment;
                const reviewNonEditHtml = `<span class="review-rating">${rating}</span>★ <span class="review-comment">${comment}</span>`;
                reviewElement.querySelector('.review-content').innerHTML = reviewNonEditHtml;
            }
        }

        async #sendEditRequest(e) {
            const reviewElement = e.target.closest('.details-review');
            const reviewId = reviewElement.dataset.reviewId;

            const formData = {
                rating: document.querySelector('input[name="Rating"]:checked').value,
                comment: document.querySelector('#editComment').value,
            };

            const response = await fetch(`/api/reviews/${reviewId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });

            if (!response.ok) {
                document.querySelector('#ratingError').innerText = "Could not edit this review.";
                return;
            }

            document.querySelector('#ratingError').innerText = "";
            this.#hideAllReviewEdits();
            reviewElement.querySelector('.review-rating').innerText = formData.rating;
            reviewElement.querySelector('.review-comment').innerText = formData.comment;
        }

        async #loadReviews(append = true) {
            const response = await fetch(`/api/artPieces/${this.artPieceId}/reviews?offset=${this.reviewsOffset}`);
            if (!response.ok) return;

            const reviews = await response.json();
            const container = document.getElementById('artReviewsContainer');

            if (!append) container.innerHTML = '';

            reviews.forEach(r => {
                const reviewEl = document.createElement('div');
                const badge = r.isCurrentUser
                    ? ' <span class="badge badge-secondary">YOU</span>'
                    : '';
                reviewEl.className = 'details-review d-flex mb-3';
                reviewEl.innerHTML =
                    `<div>` +
                    `<div><strong class="review-reviewer-name" data-user-id="${r.userId}">${r.reviewerName}</strong>${badge} -  <span class="review-points">${r.points} points</span> - <small>${new Date(r.date).toLocaleDateString()}</small></div>` +
                    `<div class="review-content"><span class="review-rating">${r.rating.value}</span>★ <span class="review-comment">${r.comment}</span></div>` +
                    `</div>`;

                if (r.isCurrentUser || r.isAdmin) {
                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<i class="bi bi-pencil-square"></i>';
                    editButton.className = 'btn edit-review-button btn-secondary btn-sm ms-2';
                    editButton.dataset.reviewId = r.reviewId;
                    editButton.addEventListener('click', async (e) => {
                        await this.#editReview(e, r);
                    });

                    reviewEl.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteButton.className = 'btn delete-review-button btn-danger btn-sm ms-2';
                    deleteButton.dataset.reviewId = r.reviewId;
                    reviewEl.appendChild(deleteButton);
                }

                if (r.isCurrentUser) reviewEl.classList.add('py-4');
                reviewEl.dataset.rating = r.rating.value;
                reviewEl.dataset.comment = r.comment;
                reviewEl.dataset.reviewId = r.reviewId;
                container.appendChild(reviewEl);
            });

            if (reviews.length > 0) this.reviewsOffset += reviews.length;

            document.querySelectorAll('.review-reviewer-name').forEach(el => {
                el.removeEventListener('click', e => this.#openUserDetails(e, el, false));
            });
            document.querySelectorAll('.review-reviewer-name').forEach(el => {
                el.addEventListener('click', e => this.#openUserDetails(e, el, false));
            });
        }

        #openUserDetails(e, el, isArtist) {
            userDetails.show(
                el,
                el.dataset.userId,
                el.textContent,
                isArtist);
        }
    }
</script>