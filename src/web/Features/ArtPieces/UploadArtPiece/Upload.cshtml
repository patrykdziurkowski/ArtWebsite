@using web.Features.ArtPieces.UploadArtPiece
@model UploadArtPieceModel

<div class="row justify-content-center">

    <div id="step-1" class="card border-0 shadow-sm">
        <div class="card-body text-center p-5">
            <h1 class="mb-4">Upload some art!</h1>
            <div class="upload-area">
                <i class="bi bi-cloud-upload fs-1 text-primary mb-3 d-block"></i>
                <label for="image-input" class="btn btn-primary btn-lg">
                    <i class="bi bi-image"></i> Choose an Image
                </label>
                <input type="file" class="d-none" id="image-input" name="Image" accept="image/*" />
                <p class="text-muted mt-3 mb-0">Select an image to get started</p>
            </div>
        </div>
    </div>

    <div id="step-2" style="display: none;" class="h-100">
        <div class="card border-0 shadow-sm h-100 d-flex">
            <div class="card-header border-0 p-3">
                <h4 class="mb-0">Edit Your Art</h4>
            </div>
            <div class="card-body p-0 flex-grow-1" style="overflow:hidden;">
                <div id="image-editor-container"></div>
            </div>
            <div class="card-footer border-0 p-3 text-end">
                <button id="apply-edits" class="btn btn-primary btn-lg">
                    Apply Edits & Continue <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="step-3" style="display: none;">
        <form id="upload-form" asp-action="Upload" method="POST" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            
            <div class="card border-0 shadow-sm">
                <div class="card-header border-0 p-3">
                    <h4 class="mb-0">Almost Done!</h4>
                </div>
                <div class="form-group d-none">
                    <label for="Image">Choose an image</label>
                    <input type="file" class="form-control" id="image-input-hidden" name="Image" accept="image/*" asp-for="Image" />
                    <span asp-validation-for="Image" class="text-danger"></span>
                </div>
                <div class="card-body p-4">
                    <div class="mb-4">
                        <label for="description-input" class="form-label fw-semibold">
                            Add a Description
                        </label>
                        <textarea class="form-control form-control-lg" 
                                    id="description-input" 
                                    name="Description" 
                                    rows="4"
                                    placeholder="Tell us about your art piece..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                </div>
                <div class="card-footer border-0 p-3 text-end">
                    <button type="button" id="back-to-edit" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Back to Edit
                    </button>
                    <button id="upload-submit" type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-upload"></i> Upload Art
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    .upload-area {
        padding: 3rem 1rem;
    }

    .upload-area label {
        cursor: pointer;
    }

    .main-buttons button {
        width: 4em !important;
    }

    .extended-buttons button {
        width: 4em !important;
    }

    #tip-container {
        display: none;
    }

    .row main {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    main > div {
        height: calc(100vh - 60px);
    }

    #canvas-holder {
        display: block;
    }

    #toolbar {
        background-color: var(--bs-secondary-bg);
    }

    #toolbar button {
        background: none;
        color: var(--bs-body-color);
        fill: var(--bs-body-color);
        stroke: var(--bs-body-color);
    }

    #toolbar div button.active {
        border: 0.5em solid var(--bs-body-color);
    }

    #toolbar button path {
        fill: inherit !important;
    }

    #image-editor-container {
        position: relative;
    }

    #image-editor-container .toolpanel {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        border-left: none;
        border-top: none;
        border-bottom: none;
    }

    #image-editor-container .toolpanel .tab-label,
    #image-editor-container .toolpanel .title {
        color: inherit;
    }

    #image-editor-container .toolpanel .custom-number-input {
        background-color: var(--bs-secondary-bg);
    }

    #image-editor-container .toolpanel input {
        border-radius: 0 !important;
        border: 2px solid var(--bs-body-color) !important;
    }
    
    #image-editor-container .toolpanel .custom-number-input button:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    #image-editor-container .toolpanel .custom-number-input button:last-child {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    #image-editor-container .floating-zoom-level-container {
        background-color: var(--bs-secondary-bg);
        z-index: 10;
        right: 1em;
        padding: 0.5em 1em;
        border-bottom: none;
    }

    #sp-container,
    .sp-picker-container,
    .sp-palette-container {
        background-color: var(--bs-body-bg);
    }

    input.sp-input {
        color: var(--bs-body-color);
    }

    .sp-container .sp-picker-container button {
        color: var(--bs-body-color);
    }

    .sp-palette span.sp-thumb-inner {
        border-radius: 0;
    }

    div.sp-container {
        border-radius: 0;
    }

    .toolpanel .content div.hide-show-handler {
        border-top-right-radius: 1em;
        border-bottom-right-radius: 1em;
        background-color: var(--bs-body-bg);
        border-left: none;
    }

    #shapes-panel svg * {
        stroke: var(--bs-body-color);
        color: var(--bs-body-color);
        fill: var(--bs-body-color);
    }
</style>

@section Scripts
{
    <link rel="stylesheet" href="~/lib/fabricjs-image-editor-origin/style.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        jQuery.fn.outerHTML = function() {
            return jQuery('<div />').append(this.eq(0).clone()).html();
        };
        Number.prototype.countDecimals = function () {
            if(Math.floor(this.valueOf()) === this.valueOf()) return 0;
            return this.toString().split(".")[1].length || 0; 
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.3/fabric.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.css">

    <script src="~/lib/fabricjs-image-editor-origin/grapick.min.js"></script>
    <link rel="stylesheet" href="~/lib/fabricjs-image-editor-origin/grapick.min.css">

    <script src="~/lib/fabricjs-image-editor-origin/undo-redo-stack.js"></script>

    <script src="~/lib/fabricjs-image-editor-origin/core.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/toolbar.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/canvas.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/shapes.js"></script>

    <script src="~/lib/fabricjs-image-editor-origin/freeDrawSettings.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/canvasSettings.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/selectionSettings.js"></script>

    <script src="~/lib/fabricjs-image-editor-origin/drawingLine.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/drawingPath.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/drawingText.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/tip.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/upload.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/copyPaste.js"></script>

    <script src="~/lib/fabricjs-image-editor-origin/utils.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/zoom.js"></script>
    <script src="~/lib/fabricjs-image-editor-origin/saveInBrowser.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let validImageLoaded = false;
            
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const step3 = document.getElementById('step-3');

            const buttons = [
                'select',
                'shapes',
                'draw',
                'line',
                'path',
                'textbox',
                'background',
                'undo',
                'redo',
                'download',
            ];

            let imgEditor = new ImageEditor('#image-editor-container', buttons, []);

            const canvasHolder = document.getElementById('canvas-holder');
            let isPanning = false;
            let lastPosX = 0;
            let lastPosY = 0;

            canvasHolder.addEventListener('mousedown', function(e) {
                if (e.button === 2) {
                    isPanning = true;
                    lastPosX = e.clientX;
                    lastPosY = e.clientY;
                    e.preventDefault();
                }
            });

            canvasHolder.addEventListener('mousemove', function(e) {
                if (isPanning) {
                    const deltaX = e.clientX - lastPosX;
                    const deltaY = e.clientY - lastPosY;
                    
                    canvasHolder.scrollLeft -= deltaX;
                    canvasHolder.scrollTop -= deltaY;
                    
                    lastPosX = e.clientX;
                    lastPosY = e.clientY;
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isPanning) {
                    isPanning = false;
                }
            });

            canvasHolder.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            document.querySelector('#image-input').onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        fabric.Image.fromURL(event.target.result, function(img) {
                            const canvas = imgEditor.canvas;
                            
                            document.querySelector('#input-height').value = img.height;
                            $(document.querySelector('#input-height')).change();
                            document.querySelector('#input-width').value = img.width;
                            $(document.querySelector('#input-width')).change();

                            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

                            validImageLoaded = true;
                            step1.style.display = 'none';
                            step2.style.display = 'block';
                        });
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            document.getElementById('apply-edits').onclick = () => {
                step2.style.display = 'none';
                step3.style.display = 'block';
            };

            document.getElementById('back-to-edit').onclick = () => {
                step3.style.display = 'none';
                step2.style.display = 'block';
            };

            document.querySelector('#upload-form').onsubmit = async (e) => {
                e.preventDefault();

                const fileInput = document.querySelector('#image-input');
                const file = fileInput.files[0];
                if (!validImageLoaded || !file || !file.type.startsWith('image/')) {
                    // send it immediately to be rejected by server side validation
                    e.target.submit();
                    return;
                }

                document.querySelector('#input-zoom-level').value = 1;
                $(document.querySelector('#input-zoom-level')).change();

                const dataURL = imgEditor.canvas.toDataURL({ format: 'png', quality: 1 });
                const blob = await (await fetch(dataURL)).blob();
                const newFile = new File([blob], 'edited-image.png', { type: 'image/png' });

                const container = new DataTransfer();
                container.items.add(newFile);
                document.querySelector('#image-input-hidden').files = container.files;

                e.target.submit();
            };
        });
    </script>
}