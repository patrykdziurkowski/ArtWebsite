@using web.Features.ArtPieces.UploadArtPiece
@model UploadArtPieceModel

<div class="h-100">
    <div class="row justify-content-center h-100">

        <div id="step-1" class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center p-5">
                <h1 class="mb-4">Upload some art!</h1>
                <div class="upload-area">
                    <i class="bi bi-cloud-upload fs-1 text-primary mb-3 d-block"></i>
                    <label for="image-input" class="btn btn-primary btn-lg">
                        <i class="bi bi-image"></i> Choose an Image
                    </label>
                    <input type="file" class="d-none" id="image-input" name="Image" accept="image/*" />
                    <p class="text-muted mt-3 mb-0">Select an image to get started</p>
                </div>
            </div>
        </div>

        <div id="step-2" style="display: none;" class="h-100">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header border-0 p-3">
                    <h4 class="mb-0">Edit Your Art</h4>
                </div>
                <div class="card-body p-0">
                    <div id="tui-image-editor-container"></div>
                </div>
                <div class="card-footer border-0 p-3 text-end">
                    <button id="apply-edits" class="btn btn-primary btn-lg">
                        Apply Edits & Continue <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="step-3" style="display: none;">
            <form id="upload-form" asp-action="Upload" method="POST" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                
                <div class="card border-0 shadow-sm">
                    <div class="card-header border-0 p-3">
                        <h4 class="mb-0">Almost Done!</h4>
                    </div>
                    <div class="form-group d-none">
                        <label for="Image">Choose an image</label>
                        <input type="file" class="form-control" id="image-input-hidden" name="Image" accept="image/*" asp-for="Image" />
                        <span asp-validation-for="Image" class="text-danger"></span>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label for="description-input" class="form-label fw-semibold">
                                Add a Description
                            </label>
                            <textarea class="form-control form-control-lg" 
                                        id="description-input" 
                                        name="Description" 
                                        rows="4"
                                        placeholder="Tell us about your art piece..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="card-footer border-0 p-3 text-end">
                        <button type="button" id="back-to-edit" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-arrow-left"></i> Back to Edit
                        </button>
                        <button id="upload-submit" type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-upload"></i> Upload Art
                        </button>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>

<link type="text/css" href="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/tui-image-editor.css">
<style>
    .upload-area {
        padding: 3rem 1rem;
    }

    .upload-area label {
        cursor: pointer;
    }

    .tui-image-editor-submenu svg .use-default {
        stroke: #8a8a8a !important;
        stroke-width: 2px;
    }

    .tui-image-editor-virtual-range-bar {
        background-color: #6a6a6a !important;
    }

    .tui-image-editor-virtual-range-subbar {
        background-color: white !important;
    }

    .tui-image-editor-container .tui-image-editor-main {
        top: 55px;
    }

    .tui-image-editor-container .tui-image-editor-wrap {
        overflow: hidden;
    }

    .tui-image-editor-range-value {
        font-weight: bold !important;
    }

    .tui-image-editor {
        top: 0 !important;
        height: 100%;
        width: 100%;
    }

    .tui-image-editor-container .tui-image-editor-help-menu.top {
        top: 0;
    }

    .tui-image-editor-menu,
    .tui-image-editor-help-menu,
    .tui-image-editor-header {
        background-color: var(--bs-secondary-bg) !important;
    }

    .tui-image-editor-main-container {
        background-image: url('/img/transparency-pattern.png') !important;
        background-size: 400px;
        background-repeat: repeat;
    }

    .tui-image-editor-container label {
        color: white !important;
        text-shadow: 1px 1px black;
    }

    .tui-image-editor-align-wrap {
        height: 100%;
    }

    .tui-image-editor-submenu {
        padding: 1em !important;
        background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.5) 50%, transparent 100%);
        height: 50% !important;
    }

    .color-picker-control {
        background-color: var(--bs-secondary-bg) !important;
    }

    .tui-colorpicker-clearfix, .tui-colorpicker-palette-hex {
        background-color: var(--bs-secondary-bg) !important;
    }
</style>

@section Scripts
{
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.4.0/fabric.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui.code-snippet/v1.5.0/tui-code-snippet.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
    <script type="text/javascript" src="~/js/tui-image-editor.js"></script>
    <script type="text/javascript" src="~/js/theme/white-theme.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        let validImageLoaded = false;
        
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');

        const imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
            includeUI: {
                loadImage: {
                    path: '/img/placeholder.png',
                    name: 'SampleImage',
                },
                theme: whiteTheme,
                initMenu: 'draw',
                menuBarPosition: 'bottom',
            },
            usageStatistics: false,
            cssMaxWidth: 3840,
            cssMaxHeight: 2160,
        });

        window.onresize = function () {
            imageEditor.ui.resizeEditor();
        };

        document.querySelector('#image-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    await imageEditor.loadImageFromFile(file);
                    validImageLoaded = true;
                    step1.style.display = 'none';
                    step2.style.display = 'block';
                    
                    setTimeout(() => {
                        document.querySelector('.tie-btn-zoomOut').remove();
                        document.querySelector('.tie-btn-zoomIn').remove();
                        const canvasContainer = document.querySelector('.tui-image-editor-canvas-container');
                        if (canvasContainer) {
                            canvasContainer.addEventListener('wheel', (event) => {
                                event.preventDefault();
                                
                                const delta = event.deltaY > 0 ? -0.1 : 0.1;
                                const canvas = imageEditor._graphics.getCanvas();
                                const currentZoom = canvas.getZoom();
                                const newZoom = Math.max(0.1, Math.min(3, currentZoom + delta));
                                
                                canvas.setZoom(newZoom);
                                canvas.renderAll();
                            }, { passive: false });
                            
                            let isPanning = false;
                            let lastPosX = 0;
                            let lastPosY = 0;
                            
                            canvasContainer.addEventListener('mousedown', (event) => {
                                const isHandTool = document.querySelector('.tie-btn-hand.on') !== null;
                                
                                if (isHandTool && event.button === 0) {
                                    isPanning = true;
                                    lastPosX = event.clientX;
                                    lastPosY = event.clientY;
                                    canvasContainer.style.cursor = 'grabbing';
                                    event.preventDefault();
                                }
                            });
                            
                            document.addEventListener('mousemove', (event) => {
                                if (isPanning) {
                                    const canvas = imageEditor._graphics.getCanvas();
                                    const deltaX = event.clientX - lastPosX;
                                    const deltaY = event.clientY - lastPosY;
                                    
                                    canvas.relativePan({ x: deltaX, y: deltaY });
                                    canvas.renderAll();
                                    
                                    lastPosX = event.clientX;
                                    lastPosY = event.clientY;
                                }
                            });
                            
                            document.addEventListener('mouseup', () => {
                                if (isPanning) {
                                    isPanning = false;
                                    canvasContainer.style.cursor = 'grab';
                                }
                            });
                        }
                    }, 200);
                } catch {
                    validImageLoaded = false;
                    alert('Failed to load image. Please try another file.');
                }
            }
        };
        
        document.getElementById('apply-edits').onclick = () => {
            step2.style.display = 'none';
            step3.style.display = 'block';
        };

        document.getElementById('back-to-edit').onclick = () => {
            step3.style.display = 'none';
            step2.style.display = 'block';
        };

        document.querySelector('#upload-form').onsubmit = async (e) => {
            e.preventDefault();

            const fileInput = document.querySelector('#image-input');
            const file = fileInput.files[0];
            if (!validImageLoaded || !file || !file.type.startsWith('image/')) {
                // send it immediately to be rejected by server side validation
                e.target.submit();
                return;
            }

            const dataURL = imageEditor.toDataURL();
            const blob = await (await fetch(dataURL)).blob();
            const newFile = new File([blob], 'edited-image.png', { type: 'image/png' });

            const container = new DataTransfer();
            container.items.add(newFile);
            document.querySelector('#image-input-hidden').files = container.files;

            e.target.submit();
        };
    });
    </script>
}