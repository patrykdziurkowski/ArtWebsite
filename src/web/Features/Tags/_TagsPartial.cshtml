<div class="art-piece-tags">
    <div class="tags-container-wrapper">
        <div class="tags-container"></div>
    </div>
</div>

<style>
    .art-piece-tags {
        width: 100%;
    }

    .tags-container-wrapper {
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 0.75rem 0;
        background: var(--bs-body-bg);
        border-radius: 0.5rem;
        cursor: grab;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .tags-container-wrapper {
        scrollbar-width: thin;
        scrollbar-color: transparent transparent;
    }

    .tags-container-wrapper:hover {
        scrollbar-color: var(--bs-secondary) transparent;
    }

    .tags-container-wrapper::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }

    .tags-container-wrapper::-webkit-scrollbar-track {
        background: transparent;
    }

    .tags-container-wrapper::-webkit-scrollbar-thumb {
        background: transparent;
        border-radius: 4px;
    }

    .tags-container-wrapper:hover::-webkit-scrollbar-thumb {
        background: var(--bs-secondary-bg);
    }

    .tags-container-wrapper:active {
        cursor: grabbing;
    }

    .tags-container {
        display: flex;
        gap: 0.5rem;
        padding: 0 1rem;
        min-width: min-content;
    }

    .tag {
        margin: 0;
        border-radius: 1rem;
        padding: 0.5rem 1rem;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        position: relative;
    }

    .tag-remove {
        position: absolute;
        right: -0.25em;
        top: -0.25em;
        opacity: 0;
        transition: opacity 0.2s ease;
        cursor: pointer;
        font-weight: bold;
        color: var(--bs-danger);
        background: var(--bs-body-bg);
        border-radius: 50%;
        width: 1em;
        height: 1em;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        line-height: 1;
    }

    .tag:hover .tag-remove {
        opacity: 1;
    }

    .tag-add {
        border: 2px dashed var(--bs-secondary);
        background: transparent !important;
        padding: 0.5rem 1rem;
    }

    .tag-input {
        border: none;
        background: transparent;
        outline: none;
        width: auto;
        padding: 0;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/9.0.6/signalr.min.js"
    integrity="sha512-kkMt8UThSmWcdXLYFaGZ/U6vyWSNLZMUWQ5SMeF80pGqrEkH5ei9D/3MbVQpB8p7D5C3A4vlX7BpsWTT2BfB6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        class Tags {
            constructor(artPieceId, containerElement, canEditTags = false) {
                this.artPieceId = artPieceId;
                this.containerElement = containerElement;
                this.tagsContainer = containerElement.querySelector('.tags-container');
                this.connection = null;
                this.canEditTags = canEditTags;

                this.tagsContainer.innerHTML = '';
            }

            async initialize() {
                try {
                    const tagsLoaded = await this.#loadTags();
                    
                    if (!tagsLoaded) {
                        this.#setupSignalR().catch(error => {
                            console.warn('SignalR setup failed:', error);
                        });
                    }
                } catch (error) {
                    console.error(`Error initializing tags for art piece ${this.artPieceId}:`, error);
                    this.tagsContainer.innerHTML = '<span class="text-danger">Error loading tags</span>';
                }

                this.#setupDragScroll();
            }

            selectTag(tag) {
                window.location.href = `/Browse?tag=${encodeURIComponent(tag)}`;
            }

            highlight(tag) {
                this.highlightedTag = tag;

                const tagElement = [...document.querySelectorAll('.tag')].find(t => 
                    [...t.childNodes]
                        .filter(node => node.nodeType === 3)
                        .map(node => node.textContent)
                        .join('').trim() === tag);
                tagElement.classList.remove('bg-body-secondary');
                tagElement.classList.add('bg-primary');
                tagElement.classList.add('text-white');
            }

            async #setupSignalR() {
                this.connection = new signalR.HubConnectionBuilder()
                    .withUrl("/tagshub")
                    .withAutomaticReconnect()
                    .build();

                this.connection.on("TagsReady", (tags) => {
                    this.#renderTags(tags);
                });

                await this.connection.start();
                await this.connection.invoke("JoinArtGroup", this.artPieceId);
            }

            async #loadTags() {
                try {
                    const res = await fetch(`/api/artpieces/${this.artPieceId}/tags`);
                    if (!res.ok) {
                        return false;
                    }

                    const tags = await res.json();
                    if (tags.length === 0) {
                        return false;
                    }

                    this.#renderTags(tags);
                    return true;
                } catch (error) {
                    console.error('Failed to load tags:', error);
                    this.tagsContainer.innerHTML = '<span class="text-danger">Failed to load tags</span>';
                    return false;
                }
            }

            #renderTags(tags) {
                this.tagsContainer.innerHTML = '';
                
                tags.forEach(tag => {
                    const span = document.createElement('span');
                    span.classList.add('tag', 'bg-body-secondary');
                    span.textContent = tag;
                    
                    if (this.canEditTags) {
                        const removeBtn = document.createElement('span');
                        removeBtn.classList.add('tag-remove');
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = async (e) => {
                            e.stopPropagation();
                            await this.#deleteTag(tag);
                        };
                        span.appendChild(removeBtn);
                    }
                    
                    span.onclick = () => this.selectTag(tag);
                    this.tagsContainer.appendChild(span);
                });
                
                if (this.canEditTags) {
                    this.#renderAddTagButton();
                }

                if (this.highlightedTag) this.highlight(this.highlightedTag);
            }

            #setupDragScroll() {
                const wrapper = this.containerElement.querySelector('.tags-container-wrapper');
                let isDown = false;
                let startX;
                let scrollLeft;
                let hasMoved = false;

                wrapper.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('tag-input')) {
                        return;
                    }
                    
                    isDown = true;
                    hasMoved = false;
                    startX = e.pageX - wrapper.offsetLeft;
                    scrollLeft = wrapper.scrollLeft;
                });

                document.addEventListener('mouseup', () => {
                    isDown = false;
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - wrapper.offsetLeft;
                    const walk = (x - startX) * 2;
                    if (Math.abs(walk) > 5) {
                        hasMoved = true;
                    }
                    wrapper.scrollLeft = scrollLeft - walk;
                });

                wrapper.addEventListener('click', (e) => {
                    if (hasMoved) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }, true);
            }

            #renderAddTagButton() {
                 if (this.tagsContainer.querySelector('.tag-add')) {
                    return;
                }

                const addTag = document.createElement('span');
                addTag.classList.add('tag', 'tag-add', 'bg-body-secondary');
                addTag.innerHTML = '<i class="bi bi-plus"></i>';
                addTag.onclick = () => this.#showTagInput(addTag);
                this.tagsContainer.prepend(addTag);
            }

            #showTagInput(addTagElement) {
                const input = document.createElement('span');
                input.contentEditable = true;
                input.classList.add('tag-input');
                
                addTagElement.innerHTML = '';
                addTagElement.appendChild(input);
                input.focus();
                
                const handleSubmit = async () => {
                    const tagName = input.textContent.trim();
                    if (tagName.length >= 2 && /^[a-zA-Z0-9]+( [a-zA-Z0-9]+)*$/.test(tagName)) {
                        await this.#createTag(tagName);
                    } else {
                        alert('Tag must be 2-16 characters and contain only alphanumeric characters and spaces');
                    }
                };
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleSubmit();
                    }
                    if (input.textContent.length >= 16) {
                        e.preventDefault();
                    }
                });
                
                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        addTagElement.remove();
                        this.#renderAddTagButton();
                    }, 200);
                });
            }

            async #createTag(tagName) {
                try {
                    const response = await fetch(`/api/artpieces/${this.artPieceId}/tags?tagName=${encodeURIComponent(tagName)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        await this.#loadTags();
                    } else {
                        alert('Failed to create tag');
                    }
                } catch (error) {
                    console.error('Error creating tag:', error);
                    alert('Failed to create tag');
                }
            }

            async #deleteTag(tagName) {
                if (!confirm(`Remove tag "${tagName}"?`)) return;
                
                try {
                    const response = await fetch(`/api/artpieces/${this.artPieceId}/tags/${encodeURIComponent(tagName)}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        await this.#loadTags();
                    } else {
                        alert('Failed to delete tag');
                    }
                } catch (error) {
                    console.error('Error deleting tag:', error);
                    alert('Failed to delete tag');
                }
            }

        }

        window.Tags = Tags;
    });
</script>