<div class="art-piece-tags">
    <div class="tags-container-wrapper">
        <div class="tags-container"></div>
    </div>
</div>

<style>
    .art-piece-tags {
        width: 100%;
        margin: 1rem 0;
    }

    .tags-container-wrapper {
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 0.75rem 0;
        background: var(--bs-body-bg);
        border-radius: 0.5rem;
        cursor: grab;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        scrollbar-width: none;
    }

    .tags-container-wrapper:hover {
        scrollbar-width: thin;
    }

    .tags-container-wrapper::-webkit-scrollbar {
        height: 8px;
        opacity: 0;
    }

    .tags-container-wrapper:hover::-webkit-scrollbar {
        opacity: 1;
    }

    .tags-container-wrapper::-webkit-scrollbar-thumb {
        background: var(--bs-secondary-bg);
        border-radius: 4px;
    }

    .tags-container-wrapper:active {
        cursor: grabbing;
    }

    .tags-container {
        display: flex;
        gap: 0.5rem;
        padding: 0 1rem;
        min-width: min-content;
    }

    .tag {
        margin: 0;
        border-radius: 1rem;
        padding: 0.5rem 1rem;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .tag:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/9.0.6/signalr.min.js"
    integrity="sha512-kkMt8UThSmWcdXLYFaGZ/U6vyWSNLZMUWQ5SMeF80pGqrEkH5ei9D/3MbVQpB8p7D5C3A4vlX7BpsWTT2BfB6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        class Tags {
            constructor(artPieceId, containerElement) {
                this.artPieceId = artPieceId;
                this.containerElement = containerElement;
                this.tagsContainer = containerElement.querySelector('.tags-container');
                this.connection = null;

                this.tagsContainer.innerHTML = '';
            }

            async initialize() {
                try {
                    await this.#setupSignalR();
                    await this.#loadTags();
                } catch (error) {
                    console.error(`Error initializing tags for art piece ${this.artPieceId}:`, error);
                    this.tagsContainer.innerHTML = '<span class="text-danger">Error loading tags</span>';
                }

                this.#setupDragScroll();
            }

            selectTag(tag) {
                window.location.href = `/Browse?tag=${encodeURIComponent(tag)}`;
            }

            highlight(tag) {
                const tagElement = [... document.querySelectorAll('.tag')].find(t => t.innerText === tag);
                tagElement.classList.remove('bg-body-secondary');
                tagElement.classList.add('bg-primary');
            }

            async #setupSignalR() {
                this.connection = new signalR.HubConnectionBuilder()
                    .withUrl("/tagshub")
                    .withAutomaticReconnect()
                    .build();

                this.connection.on("TagsReady", (tags) => {
                    this.#renderTags(tags);
                });

                await this.connection.start();
                await this.connection.invoke("JoinArtGroup", this.artPieceId);
            }

            async #loadTags() {
                const res = await fetch(`/api/artpieces/${this.artPieceId}/tags`);
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }

                const tags = await res.json();
                if (tags.length === 0) {
                    this.tagsContainer.innerHTML = '<span class="text-muted">No tags</span>';
                    return;
                }

                this.#renderTags(tags);
            }

            #renderTags(tags) {
                this.tagsContainer.innerHTML = '';
                tags.forEach(tag => {
                    const span = document.createElement('span');
                    span.classList.add('tag', 'bg-body-secondary');
                    span.textContent = tag;
                    span.onclick = () => this.selectTag(tag);
                    this.tagsContainer.appendChild(span);
                });
            }

            #setupDragScroll() {
                const wrapper = this.containerElement.querySelector('.tags-container-wrapper');
                let isDown = false;
                let startX;
                let scrollLeft;
                let hasMoved = false;

                wrapper.addEventListener('mousedown', (e) => {
                    isDown = true;
                    hasMoved = false;
                    startX = e.pageX - wrapper.offsetLeft;
                    scrollLeft = wrapper.scrollLeft;
                });

                document.addEventListener('mouseup', () => {
                    isDown = false;
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - wrapper.offsetLeft;
                    const walk = (x - startX) * 2;
                    if (Math.abs(walk) > 5) {
                        hasMoved = true;
                    }
                    wrapper.scrollLeft = scrollLeft - walk;
                });

                wrapper.addEventListener('click', (e) => {
                    if (hasMoved) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }, true);
            }

        }

        window.Tags = Tags;
    });
</script>