@using web.Features.Browse
@using web.Features.Reviews.ReviewArtPiece
@model BrowseModel

@{
    string reviewCooldown = Environment.GetEnvironmentVariable("REVIEW_COOLDOWN_SECONDS")!;
}

<div class="container h-100 d-flex flex-column p-0 position-relative">
    <partial name="../Tags/_TagsPartial" />
    <div id="artContainer" class="m-auto d-flex flex-column text-center flex-grow-1">        
        <div id="imgWrapper" class="flex-grow-1 d-flex align-items-center justify-content-center position-relative" style="min-height: 0;">
            <button id="toggleDescription" class="btn btn-sm position-absolute top-0 start-50 translate-middle-x m-2 bg-dark bg-opacity-75 text-white border-2 rounded-pill px-3" style="z-index: 20;">
                <i class="bi bi-three-dots"></i>
            </button>
            
            <div id="descriptionOverlay" class="position-absolute top-0 start-0 end-0 p-4 d-none" style="z-index: 15; background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%);">
                <p id="overlayDescription" class="text-white mt-4 text-center"></p>
            </div>
            
            <img id="artPieceImage" 
                src=""
                alt="Art Piece" 
                class="img-fluid rounded d-none" 
                style="height: 100%; max-width: 100%; object-fit: cover;">
        </div>
    </div>

    <div id="artPieceControls" class="d-none position-absolute bottom-0 start-0 end-0 pb-4" style="z-index: 10;">
        <div class="row">
            <div class="col-4"></div>
            <div class="col-4 text-center">
                <button id="reviewArt" class="btn btn-primary shadow" disabled>
                    <i class="bi bi-justify-left"></i>
                </button>
            </div>
            <div class="col-4">
                <button id="skipButton" class="btn btn-secondary rounded-circle position-relative shadow" 
                @(Model.CurrentReviewerActivePoints < 5 ? "disabled" : "")>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">
                        <span id="skip-button-points">@Model.CurrentReviewerActivePoints</span>/5
                    </span>
                    <i class="bi bi-skip-forward"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="postReviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-2">
                <h5 class="modal-title fw-bold">Review Submitted!</h5>
                <button type="button" class="btn-close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-check-circle text-success fs-1 mb-3 d-block"></i>
                <p class="text-muted mb-0">What would you like to do next?</p>
            </div>
            <div class="modal-footer border-0 justify-content-center gap-2 pt-0">
                <button id="likeArtPiece" class="btn btn-outline-danger">
                    <i class="bi bi-heart"></i> Like
                </button>
                <button id="nextArtPiece" class="btn btn-primary">
                    <i class="bi bi-arrow-right"></i> Next Art
                </button>
                <button id="viewArtPiece" class="btn btn-outline-secondary">
                    <i class="bi bi-eye"></i> Details
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-2">
                <h5 class="modal-title fw-bold">Review This Art</h5>
                <button type="button" class="btn-close"></button>
            </div>
            <div class="modal-body px-4 py-4">
                <form asp-controller="Review" asp-action="ReviewArtPiece" method="post" id="reviewForm">
                    <div class="mb-4">
                        <label for="comment" class="form-label fw-semibold">Your Review</label>
                        <textarea name="comment" 
                                  class="form-control form-control-lg" 
                                  placeholder="Share your thoughts about this art piece..." 
                                  rows="4"
                                  required
                                  asp-for="ReviewForm.Comment"></textarea>
                        <span asp-validation-for="ReviewForm.Comment" class="text-danger small"></span>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-semibold d-block mb-3">Rating</label>
                        <div class="rating justify-content-center">
                            <input type="radio" id="star5" name="Rating" asp-for="ReviewForm.Rating" value="5">
                            <label for="star5">&#9733;</label>
                            <input type="radio" id="star4" name="Rating" asp-for="ReviewForm.Rating" value="4">
                            <label for="star4">&#9733;</label>
                            <input type="radio" id="star3" name="Rating" asp-for="ReviewForm.Rating" value="3">
                            <label for="star3">&#9733;</label>
                            <input type="radio" id="star2" name="Rating" asp-for="ReviewForm.Rating" value="2">
                            <label for="star2">&#9733;</label>
                            <input type="radio" id="star1" name="Rating" asp-for="ReviewForm.Rating" value="1">
                            <label for="star1">&#9733;</label>
                        </div>
                        <span asp-validation-for="ReviewForm.Rating" class="text-danger small d-block text-center"></span>
                    </div>
                    
                    <input type="hidden" name="artPieceId" value="">
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-send"></i> Submit Review
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<partial name="../ArtPieces/_ArtPieceDetailsModalPartial" />

<style>
    .rating {
        font-size: 2rem;
    }

    .rating label {
        transition: all 0.2s ease;
    }

    .rating label:hover {
        transform: scale(1.2);
    }

    #skipButton {
        font-size: 1.5em;
        width: 60px;
        height: 60px;
    }

    #skipButton:disabled {
            background-color: rgba(100, 100, 100, 0.5); 
    }

    #reviewArt {
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            font-size: 2em;
            width: 60px;
            height: 60px;
    }

    #reviewArt::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            height: 100%;
    }

    #reviewArt>i {
            position: relative;
            z-index: 5;
    }

    #reviewArt[disabled="disabled"]::before {
            animation-name: review-loading-animation;
            animation-duration: var(--review-cooldown);
            animation-timing-function: linear;
            animation-fill-mode: forwards;
            animation-iteration-count: 1;
    }

    #reviewArt:not([disabled="disabled"])::before {
            opacity: 0;
    }

</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const tagParameter = params.get('tag');

            let artPieceTags = null;
            let artPieceId;
            let artPieceDetails = null;
            let reviewTimeout = null;
            let isLiked = false;
            let currentPoints = @Model.CurrentReviewerActivePoints;
            let artPiece = await loadArtPiece();

            if (artPiece === null) return;

            artPieceId = artPiece.id.value;

            const likeButton = document.querySelector('#likeArtPiece');
            const reviewForm = document.querySelector('#reviewForm');
            const reviewModal = new bootstrap.Modal(document.querySelector('#reviewModal'));
            const postReviewModal = new bootstrap.Modal(document.querySelector('#postReviewModal'));

            const toggleDescriptionBtn = document.getElementById('toggleDescription');
            const descriptionOverlay = document.getElementById('descriptionOverlay');

            toggleDescriptionBtn.addEventListener('click', () => {
                descriptionOverlay.classList.toggle('d-none');
            });

            const imageViewer = ImageViewer.getInstance();
            const img = document.getElementById('artPieceImage');
            img.addEventListener('click', () => {
                imageViewer.open(img.src, img.alt);
            });

            // note: this is registered here via event listener instead of using boostrap's data tags
            // because of issues when using both data-bs-dismiss alongside new bootstrap.Modal(...)
            document.querySelector('#reviewModal .btn-close').addEventListener('click', () => {
                reviewModal.hide();
            });
            document.querySelector('#postReviewModal .btn-close').addEventListener('click', () => {
                postReviewModal.hide();
            });

            async function nextArtPiece() {
                postReviewModal.hide();
                artPieceDetails.hide();
                await loadArtPiece();
            }

            function showDetails() {
                postReviewModal.hide();
                artPieceDetails.show();
            }

            function artPieceReviewed() {
                reviewModal.hide();
                postReviewModal.show();

                artPieceDetails = new ArtPieceDetails(artPieceId);
                artPieceDetails.onBack = () => {
                    postReviewModal.show();
                };
                artPieceDetails.onHidden = async () => {
                    if (!postReviewModal._element.classList.contains('show')) {
                        await loadArtPiece();
                    }
                };

                postReviewModal._element.addEventListener('hidden.bs.modal', async () => {
                    if (!artPieceDetails.isShown) {
                        await loadArtPiece();
                    }
                });
            }

            function disableReviewingUntilReady() {
                const button = document.getElementById('reviewArt');
                if (reviewTimeout !== null) {
                    clearTimeout(reviewTimeout);
                }

                button.setAttribute('disabled', 'disabled');

                reviewTimeout = setTimeout(() => {
                    button.removeAttribute('disabled');
                }, Number(@reviewCooldown) * 1000);
            }

            async function loadArtPiece() {
                const urlParams = new URLSearchParams(window.location.search);
                const tagParam = urlParams.get('tag');
                const url = (tagParam === null) ? '/api/artpiece' : `/api/artpiece?tag=${encodeURIComponent(tagParam)}`;
                const response = await fetch(url);
                const artContainer = document.getElementById('artContainer');
                
                if (response.status === 204) {
                    artContainer.textContent = '';
                    const noImagesH1 = document.createElement('h1');
                    noImagesH1.textContent = 'No more images to review.';
                    artContainer.appendChild(noImagesH1);
                    document.querySelector('#artPieceControls').classList.add('d-none');
                    return null;
                }
                
                const data = await response.json();
                
                if (!data || !data.imagePath) {
                    artContainer.textContent = '';
                    const noImagesH1 = document.createElement('h1');
                    noImagesH1.textContent = 'No more images to review.';
                    artContainer.appendChild(noImagesH1);
                    document.querySelector('#artPieceControls').classList.add('d-none');
                    return null;
                }
                
                overlayDescription.textContent = data.description;
                artPieceImage.src = data.imagePath;
                artPieceImage.classList.remove('d-none');
                imgWrapper.classList.remove('d-none');
                document.querySelector('#descriptionOverlay').classList.add('d-none');
                
                document.querySelector('#reviewForm input[name="artPieceId"]').value = data.id.value;
                artPieceId = data.id.value;

                artPieceTags = new Tags(artPieceId, document.querySelector('.container .art-piece-tags'));
                await artPieceTags.initialize();
                if (tagParameter !== null && tagParameter !== "") {
                    artPieceTags.highlight(tagParameter);
                }

                disableReviewingUntilReady();

                document.querySelector('#artPieceControls').classList.remove('d-none');

                return data;
            }

            async function like(e) {
                const artPieceId = document.querySelector('#reviewForm input[name="artPieceId"]').value;

                if (isLiked) {
                    const response = await fetch(`/api/artpieces/${artPieceId}/like`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        console.error('Failed to unlike the art piece', response.statusText);
                        return;
                    }

                    likeButton.innerHTML = '<i class="bi bi-heart"></i> Like';
                    isLiked = false;
                } else {
                    const response = await fetch(`/api/artpieces/${artPieceId}/like`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        console.error('Failed to like the art piece', response.statusText);
                        return;
                    }

                    likeButton.innerHTML = '<i class="bi bi-heart-fill"></i> Unlike';
                    isLiked = true;
                }
            }

            async function review(e) {
                e.preventDefault();
                const form = new FormData(e.target);

                const data = {
                    comment: form.get('comment'),
                    rating: document.querySelector('input[name="Rating"]:checked').value,
                    artPieceId: form.get('artPieceId')
                };

                const response = await fetch('/api/reviews/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.status !== 200) {
                    const data = await response.json();
                    const validationErrorsText = document.querySelector('#reviewForm *[name="comment"] + span');
                    validationErrorsText.innerText = data.errors.Comment;
                    return;
                }

                currentPoints += 10;
                document.querySelector('#skip-button-points').innerText = currentPoints;
                document.querySelector('#skipButton').disabled = currentPoints < 5;
                artPieceReviewed();
            }

            document.getElementById('skipButton').addEventListener('click', async function() {
                const button = this;
                button.disabled = true;
                
                try {
                    const response = await fetch('/api/artpieces/current', {
                        method: 'DELETE',
                    });
                    
                    if (!response.ok) {
                        const data = await response.json();
                        alert('Failed to skip: ' + (data.errors?.[0]?.message || 'Unknown error'));
                        
                        return;
                    }

                    currentPoints -= 5;
                    document.getElementById('reviewArt').removeAttribute('disabled', 'disabled');
                    await loadArtPiece();
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while skipping');
                }

                document.querySelector('#skip-button-points').innerText = currentPoints;
                document.querySelector('#skipButton').disabled = currentPoints < 5;
            });

            likeButton.addEventListener('click', like);
            reviewForm.addEventListener('submit', review);
            document.querySelector('#reviewArt').addEventListener('click', () => {
                reviewModal.show();
            });

            document.querySelector('#nextArtPiece').addEventListener('click', nextArtPiece);
            document.querySelector('#viewArtPiece').addEventListener('click', showDetails);

            document.documentElement.style.setProperty('--review-cooldown', '@reviewCooldown' + 's');
        });
    </script>
}